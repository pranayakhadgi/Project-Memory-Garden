<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Memory Garden ‚Äì Animated Flower Growth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ===== Reset & font ===== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        
        body,
        html {
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, #f0fdf4, #d8f3dc, #fde2e4, #fff1e6);
            background-size: 400% 400%;
            animation: softMove 16s ease-in-out infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #123;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            padding-bottom: 220px;
        }
        
        @keyframes softMove {
            0% {
                background-position: 0% 50%
            }
            50% {
                background-position: 100% 50%
            }
            100% {
                background-position: 0% 50%
            }
        }
        /* ===== Soil container ===== */
        
        .soil-area {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 220px;
            background: linear-gradient(180deg, #8b6f47 0%, #6b4f38 15%, #5a3f2e 35%, #4a3426 60%, #3d2a1f 85%, #2f1f16 100%);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.12), inset 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 0;
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 15px;
            cursor: default;
        }
        
        .soil-area::before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            background-image: radial-gradient(circle at 20% 30%, rgba(139, 111, 71, 0.3) 1px, transparent 2px), radial-gradient(circle at 60% 70%, rgba(107, 79, 56, 0.4) 1px, transparent 2px), radial-gradient(circle at 80% 20%, rgba(90, 63, 46, 0.3) 1px, transparent 2px), radial-gradient(circle at 40% 80%, rgba(74, 52, 38, 0.4) 1px, transparent 2px), radial-gradient(circle at 10% 60%, rgba(61, 42, 31, 0.3) 1px, transparent 2px);
            background-size: 8px 8px, 12px 12px, 6px 6px, 10px 10px, 14px 14px;
            mix-blend-mode: multiply;
            opacity: 0.7;
            pointer-events: none;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
        }
        
        .soil-area::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            background-image: radial-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px), radial-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px), radial-gradient(rgba(139, 111, 71, 0.1) 0.5px, transparent 0.5px);
            background-size: 4px 4px, 8px 8px, 2px 2px;
            mix-blend-mode: overlay;
            opacity: 0.8;
            pointer-events: none;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
        }
        
        .soil-pebbles {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            height: 60px;
            background-image: radial-gradient(circle at 5% 20%, rgba(0, 0, 0, 0.12) 3px, transparent 4px), radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.05) 2px, transparent 3px), radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.08) 2px, transparent 3px), radial-gradient(circle at 60% 40%, rgba(0, 0, 0, 0.1) 3px, transparent 4px), radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.03) 2px, transparent 3px), radial-gradient(circle at 25% 80%, rgba(139, 111, 71, 0.15) 2px, transparent 3px), radial-gradient(circle at 70% 70%, rgba(107, 79, 56, 0.12) 2px, transparent 3px);
            opacity: 0.9;
            filter: blur(0.2px);
            pointer-events: none;
        }
        
        .flower {
            position: absolute;
            bottom: 80px;
            transform-origin: bottom center;
            pointer-events: auto;
            z-index: 5;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        
        .flower:hover {
            transform: scale(1.15) translateY(-5px) !important;
            filter: brightness(1.1) drop-shadow(0 8px 16px rgba(0, 0, 0, 0.2));
            z-index: 100;
        }
        /* ===== Flower Tooltip ===== */
        
        .flower-tooltip {
            display: none;
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            min-width: 280px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            z-index: 1000;
            pointer-events: none;
            border: 2px solid rgba(45, 104, 79, 0.2);
        }
        
        .tooltip-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d6a4f;
            padding: 12px 15px 8px 15px;
            border-bottom: 2px solid #e6f6ec;
        }
        
        .tooltip-date {
            font-size: 0.75rem;
            color: #666;
            padding: 0 15px 10px 15px;
            font-style: italic;
        }
        
        .tooltip-summary {
            padding: 12px 15px;
            background: #f0fdf4;
            color: #1b4332;
            line-height: 1.5;
            font-weight: 500;
        }
        
        .tooltip-separator {
            height: 1px;
            background: linear-gradient(to right, transparent, #52b788, transparent);
            margin: 10px 0;
        }
        
        .tooltip-content {
            padding: 12px 15px;
            max-height: 220px;
            overflow-y: auto;
        }
        
        .tooltip-msg-user,
        .tooltip-msg-assistant {
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 8px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .tooltip-msg-user {
            background: #e6f6ec;
            color: #1b4332;
            margin-left: auto;
            border-left: 3px solid #52b788;
        }
        
        .tooltip-msg-user::before {
            content: "You: ";
            font-weight: 700;
            color: #2d6a4f;
        }
        
        .tooltip-msg-assistant {
            background: rgba(255, 255, 255, 0.8);
            color: #123;
            border-left: 3px solid #95d5b2;
        }
        
        .tooltip-msg-assistant::before {
            content: "Guide: ";
            font-weight: 700;
            color: #40916c;
        }
        
        .tooltip-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .tooltip-content::-webkit-scrollbar-track {
            background: #f0fdf4;
            border-radius: 3px;
        }
        
        .tooltip-content::-webkit-scrollbar-thumb {
            background: #95d5b2;
            border-radius: 3px;
        }
        
        .tooltip-content::-webkit-scrollbar-thumb:hover {
            background: #74c69d;
        }
        /* ===== Page layout ===== */
        
        .page {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            z-index: 10;
            position: relative;
            padding: 28px 28px 0 28px;
        }
        
        .confession-section {
            width: 100%;
            text-align: center;
        }
        
        .confession-section h2 {
            font-size: 2rem;
            font-weight: 800;
            color: #2d6a4f;
            margin-bottom: 8px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
        }
        
        .confession-input {
            width: 100%;
            max-width: 620px;
            padding: 14px 18px;
            font-size: 1.15rem;
            border-radius: 10px;
            border: 1.5px solid rgba(45, 104, 79, 0.4);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.07);
            outline: none;
            transition: border-color 0.3s ease;
            background: #fff;
        }
        
        .confession-input:focus {
            border-color: #52b788;
        }
        
        .diary-section {
            width: 100%;
            max-width: 700px;
            text-align: center;
        }
        
        .diary-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d6a4f;
            margin-bottom: 12px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
        }
        
        .diary-input {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 16px;
            font-size: 1.05rem;
            color: #123;
            border: none;
            resize: vertical;
            box-shadow: inset 0 4px 12px rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(6px);
            outline: none;
            transition: box-shadow 0.3s ease;
        }
        
        .diary-input:focus {
            box-shadow: inset 0 6px 18px rgba(255, 255, 255, 0.6);
        }
        
        .diary-input::placeholder {
            color: #2d6a4f;
            opacity: .85;
        }
        /* ===== Mood panel ===== */
        
        .mood-question {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.92);
            padding: 20px 25px;
            border-radius: 18px;
            box-shadow: 0 6px 18px rgba(45, 104, 79, 0.18);
            text-align: center;
            max-width: 700px;
            width: 95vw;
            z-index: 100;
        }
        
        .mood-question h3 {
            font-weight: 700;
            color: #2d6a4f;
            font-size: 1.3rem;
            margin-bottom: 18px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .mood-buttons {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .mood-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 12px 8px;
            border-radius: 12px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: #e6f6ec;
            color: #2d6a4f;
            box-shadow: 0 4px 12px rgba(45, 104, 79, 0.12);
            transition: background 0.25s ease, transform 0.18s ease;
        }
        
        .mood-buttons button:hover {
            background: linear-gradient(180deg, #74c69d, #52b788);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(45, 104, 79, 0.28);
        }
        
        .mood-buttons button.active {
            background: linear-gradient(180deg, #52b788, #40916c);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(45, 104, 79, 0.35);
        }
        /* ===== Flowers ===== */
        /* Wilted Flower (Extremely Sad) */
        
        .flower.wilted {
            width: 90px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .wilted .stem {
            --stem-height: 100px;
            width: 6px;
            animation: growStem 1000ms cubic-bezier(.0, .9, .2, 1) forwards, swayStem 6.5s ease-in-out infinite 1.5s;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #5a4a3a 0%, #4a3a2a 30%, #3a2a1a 70%, #2a1a0a 100%);
            opacity: 0.7;
        }
        
        .wilted .head {
            position: relative;
            width: 50px;
            height: 70px;
            transform: scale(0.01) translateY(0px) rotate(30deg);
            animation: bloomFlower 600ms ease-out 700ms forwards;
            border-radius: 50% 50% 40% 40%;
            background: linear-gradient(140deg, #4a3a3a 0%, #3a2a2a 50%, #2a1a1a 100%);
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        /* Tulip (Sad) */
        
        .flower.tulip {
            width: 100px;
            height: 210px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tulip .stem {
            --stem-height: 120px;
            width: 7px;
            animation: growStem 1100ms cubic-bezier(.0, .9, .2, 1) forwards, swayStem 6.2s ease-in-out infinite 1.4s;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #3d7a5f 0%, #2d6a4f 30%, #1e4d2f 70%, #0f2f1f 100%);
            border-radius: 4px;
        }
        
        .tulip .bud {
            position: relative;
            width: 60px;
            height: 85px;
            top: 0px;
            transform-origin: bottom center;
            transform: translateY(0px) scale(0.01);
            animation: bloomFlower 700ms ease-out 800ms forwards;
            border-radius: 55% 45% 35% 35% / 75% 75% 35% 35%;
            background: linear-gradient(140deg, #ff6b47 0%, #ff5722 30%, #e64a19 60%, #d84315 100%);
            box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.1), 0 8px 15px rgba(0, 0, 0, 0.2), inset 0 -2px 5px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 107, 71, 0.3);
        }
        /* Rose (Neutral) */
        
        .flower.rose {
            width: 130px;
            height: 210px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .rose .stem {
            --stem-height: 130px;
            width: 8px;
            animation: growStem 1200ms cubic-bezier(.0, .9, .2, 1) forwards, swayStem 5.8s ease-in-out infinite 1.8s;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #3d7a5f 0%, #2d6a4f 30%, #1e4d2f 70%, #0f2f1f 100%);
        }
        
        .rose .head {
            position: relative;
            top: 0px;
            transform: scale(0.01) translateY(0px);
            animation: bloomFlower 800ms ease-out 900ms forwards, swayFlower 5.8s ease-in-out infinite 2.3s;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
        }
        
        .rose .petal {
            position: absolute;
            background: radial-gradient(circle at 25% 25%, #ffffff 0%, #fefefe 30%, #f5f5f5 70%, #e8e8e8 100%);
            border-radius: 50%;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03), inset 0 -1px 4px rgba(255, 255, 255, 0.8), 0 1px 3px rgba(0, 0, 0, 0.1);
            opacity: 0.95;
            transition: opacity 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .rose .petal.p1 {
            width: 45px;
            height: 45px;
            left: 20px;
            top: 30px;
            transform: rotate(-25deg);
            z-index: 3;
        }
        
        .rose .petal.p2 {
            width: 55px;
            height: 55px;
            left: 35px;
            top: 20px;
            transform: rotate(15deg);
            z-index: 4;
        }
        
        .rose .petal.p3 {
            width: 65px;
            height: 65px;
            left: 20px;
            top: 10px;
            transform: rotate(-8deg);
            z-index: 2;
        }
        
        .rose .petal.p4 {
            width: 50px;
            height: 50px;
            left: 40px;
            top: 35px;
            transform: rotate(35deg);
            z-index: 1;
        }
        
        .rose .center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f8f8f8 50%, #e8e8e8 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 3px rgba(255, 255, 255, 0.8);
            z-index: 5;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
        /* Daisy (Slightly Happy) */
        
        .flower.daisy {
            width: 140px;
            height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .daisy .stem {
            --stem-height: 135px;
            width: 9px;
            animation: growStem 1300ms cubic-bezier(.0, .9, .2, 1) forwards, swayStem 5.6s ease-in-out infinite 1.9s;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #4d8a6f 0%, #3d7a5f 25%, #2d6a4f 60%, #1e4d2f 85%, #0f2f1f 100%);
        }
        
        .daisy .head {
            width: 110px;
            height: 110px;
            border-radius: 999px;
            position: relative;
            transform-origin: center;
            transform: translateY(0px) scale(0.01);
            animation: bloomFlower 900ms ease-out 950ms forwards, swayFlower 5.6s ease-in-out infinite 2.5s;
            filter: drop-shadow(0 5px 12px rgba(0, 0, 0, 0.12));
        }
        
        .daisy .center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 40% 40%, #FFD700 0%, #FFC700 50%, #FFB700 100%);
            border-radius: 50%;
            box-shadow: inset 0 0 6px 1px #FFAA00, 0 3px 8px rgba(0, 0, 0, 0.15);
            z-index: 3;
            border: 1px solid rgba(255, 200, 0, 0.4);
        }
        
        .daisy .petal {
            position: absolute;
            width: 24px;
            height: 50px;
            background: linear-gradient(180deg, #ffffff 0%, #fffef8 30%, #fffaed 70%, #fff5e0 100%);
            border-radius: 50% 50% 50% 50%;
            transform-origin: 50% 100%;
            left: 50%;
            top: 12%;
            opacity: 0;
            z-index: 1;
            box-shadow: inset 0 1px 4px rgba(255, 255, 255, 0.6), 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 250, 230, 0.5);
        }
        
        .daisy .head.show-petals .petal {
            animation: petalPop 400ms ease forwards;
        }
        /* Sunflower (Very Happy) */
        
        .flower.sunflower {
            width: 150px;
            height: 240px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .sunflower .stem {
            --stem-height: 140px;
            width: 10px;
            animation: growStem 1400ms cubic-bezier(.0, .9, .2, 1) forwards, swayStem 5.5s ease-in-out infinite 2s;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #4d8a6f 0%, #3d7a5f 25%, #2d6a4f 60%, #1e4d2f 85%, #0f2f1f 100%);
        }
        
        .sunflower .head {
            width: 130px;
            height: 130px;
            border-radius: 999px;
            position: relative;
            transform-origin: center;
            transform: translateY(0px) scale(0.01);
            animation: bloomFlower 1000ms ease-out 1000ms forwards, swayFlower 5.5s ease-in-out infinite 2.8s;
            filter: drop-shadow(0 6px 15px rgba(0, 0, 0, 0.15));
        }
        
        .sunflower .center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 40% 40%, #8b4513 0%, #654321 30%, #4a2c00 70%, #2d1a00 100%);
            border-radius: 50%;
            box-shadow: inset 0 0 8px 1px #6a4921, 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.1);
            z-index: 3;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }
        
        .sunflower .center::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.8) 1px, transparent 1px), radial-gradient(circle at 60% 30%, rgba(101, 67, 33, 0.8) 1px, transparent 1px), radial-gradient(circle at 40% 60%, rgba(74, 44, 0, 0.8) 1px, transparent 1px), radial-gradient(circle at 80% 70%, rgba(139, 69, 19, 0.8) 1px, transparent 1px), radial-gradient(circle at 30% 80%, rgba(101, 67, 33, 0.8) 1px, transparent 1px);
            background-size: 6px 6px, 8px 8px, 7px 7px, 5px 5px, 9px 9px;
            border-radius: 50%;
        }
        
        .sunflower .petal {
            position: absolute;
            width: 28px;
            height: 65px;
            background: linear-gradient(180deg, #ffd700 0%, #ffeb3b 20%, #ffc107 50%, #ff8f00 80%, #ff6f00 100%);
            border-radius: 80% 20% 70% 30%/100% 100% 60% 40%;
            transform-origin: 50% 95%;
            left: 50%;
            top: 8%;
            opacity: 0;
            z-index: 1;
            box-shadow: inset 0 2px 8px rgba(255, 215, 0, 0.4), inset 0 -1px 4px rgba(255, 140, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
        }
        
        .sunflower .head.show-petals .petal {
            animation: petalPop 450ms ease forwards;
        }
        
        .stem {
            position: relative;
            width: 8px;
            height: 0;
            background: linear-gradient(180deg, #3d7a5f 0%, #2d6a4f 30%, #1e4 f 70%, #0f2f1f 100%);
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 50, 0, 0.3), inset 1px 0 2px rgba(255, 255, 255, 0.1), inset -1px 0 2px rgba(0, 0, 0, 0.1);
            transform-origin: bottom;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        @keyframes growStem {
            0% {
                height: 0;
                transform: translateY(8px) scaleY(0.01);
                opacity: 0;
                filter: blur(2px);
            }
            20% {
                opacity: .3;
                filter: blur(1px);
            }
            60% {
                opacity: .8;
                filter: blur(.5px);
            }
            100% {
                height: var(--stem-height);
                transform: translateY(0) scaleY(1);
                opacity: 1;
                filter: blur(0);
            }
        }
        
        @keyframes bloomFlower {
            0% {
                transform: scale(0.01) translateY(10px);
                opacity: 0;
            }
            60% {
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(0px);
                opacity: 1;
            }
        }
        
        @keyframes swayFlower {
            0%,
            100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-3deg) scale(1.02);
            }
            75% {
                transform: rotate(3deg) scale(1.02);
            }
        }
        
        @keyframes swayStem {
            0%,
            100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-2deg);
            }
            75% {
                transform: rotate(2deg);
            }
        }
        
        @keyframes petalPop {
            0% {
                opacity: 0;
                transform: translateX(-50%) rotate(var(--rot)) scale(.1);
            }
            60% {
                opacity: 0.8;
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) rotate(var(--rot)) scale(1);
            }
        }
        /* ===== Chat layout + bubbles ===== */
        
        #chatWindow {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .bubble {
            margin: 0;
            padding: 10px 12px;
            border-radius: 10px;
            max-width: 85%;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .bubble.user {
            background: #e6f6ec;
            color: #1b4332;
            margin-left: auto;
            box-shadow: 0 4px 12px rgba(45, 104, 79, .12);
        }
        
        .bubble.assistant {
            background: rgba(255, 255, 255, .9);
            color: #123;
            border: 1px solid rgba(45, 104, 79, .08);
            box-shadow: 0 4px 12px rgba(16, 24, 32, .08);
        }
        
        @media (max-width: 768px) {
            .mood-buttons {
                flex-direction: column;
            }
            .mood-buttons button {
                width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <!-- Confession seed (optional) -->
        <section class="confession-section" aria-label="My Confession">
            <h2>Title</h2>
            <input id="confessionSeed" type="text" class="confession-input" placeholder="Share a tiny thought or secret..." />
        </section>

        <!-- Chat block -->
        <section class="diary-section" aria-label="Chat with Garden Guide">
            <h2>My Diary Entry</h2>
            <div id="chatWindow" style="
              width:100%;max-width:700px;margin:10px auto 16px auto;
              background:rgba(255,255,255,0.55);border-radius:12px;padding:14px;
              box-shadow:0 8px 24px rgba(16,24,32,0.08);backdrop-filter:blur(6px);
              height:200px;overflow:auto;border:1px solid rgba(45,104,79,0.08)">
            </div>
            <div style="display:flex;gap:10px;align-items:flex-start;max-width:700px;width:100%;">
                <textarea id="chatInput" class="diary-input" style="min-height:100px;" placeholder="Tell me what's on your mind‚Ä¶"></textarea>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button id="sendBtn" style="padding:12px 16px;border:none;border-radius:10px;background:#52b788;color:#fff;font-weight:700;cursor:pointer;">Send</button>
                    <button id="finishBtn" style="padding:10px 16px;border:none;border-radius:10px;background:#2d6a4f;color:#fff;font-weight:700;cursor:pointer;">Finish</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Mood -->
    <section class="mood-question" aria-label="How are you feeling today?">
        <h3>How are you feeling?</h3>
        <div class="mood-buttons" role="group" aria-label="Mood selection">
            <button type="button" data-mood="extremely_sad" aria-pressed="false">üò¢ Extremely Sad</button>
            <button type="button" data-mood="sad" aria-pressed="false">üòî Sad</button>
            <button type="button" data-mood="neutral" aria-pressed="false">üòê Neutral</button>
            <button type="button" data-mood="slightly_happy" aria-pressed="false">üôÇ Slightly Happy</button>
            <button type="button" data-mood="very_happy" aria-pressed="false">üòÑ Very Happy</button>
        </div>
    </section>

    <!-- Soil -->
    <div class="soil-area" aria-hidden="true" aria-label="Soil where flowers grow">
        <div class="soil-pebbles" aria-hidden="true"></div>
    </div>

    <!-- Script -->
    <script>
        // ===== Auth + mood storage
        const token = localStorage.getItem("mg_token");
        const user = JSON.parse(localStorage.getItem("mg_user") || "null");
        if (!token || !user) window.location.href = "index.html";

        const MOOD_KEY = `mg_current_mood_${user.id || user.username}`;
        const BACKEND = "http://localhost:5000";

        function currentMood() {
            const m = (localStorage.getItem(MOOD_KEY) || "neutral").toLowerCase();
            return ["extremely_sad", "sad", "neutral", "slightly_happy", "very_happy"].includes(m) ? m : "neutral";
        }

        // ===== Load and display all flowers from MongoDB
        const soil = document.querySelector(".soil-area");
        console.log("üå∏ Soil element found:", soil);
        let allFlowers = [];

        async function loadFlowersFromDB() {
            try {
                const res = await fetch(`${BACKEND}/api/flowers`, {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    const flowers = await res.json();
                    allFlowers = flowers || [];
                    console.log(`üå∏ Loaded ${allFlowers.length} flowers from database`);
                    displayAllFlowers();
                } else {
                    console.error("Failed to load flowers:", res.status);
                }
            } catch (e) {
                console.error("Failed to load flowers:", e);
            }
        }

        function displayAllFlowers() {
            console.log(`üå∏ Displaying ${allFlowers.length} flowers`);
            
            // Clear existing flowers first to prevent duplicates (but keep soil pebbles)
            const existingFlowers = soil.querySelectorAll('.flower');
            existingFlowers.forEach(flower => flower.remove());
            
            const screenWidth = window.innerWidth;
            const totalFlowers = allFlowers.length;
            const spacing = totalFlowers > 0 ? Math.min(180, (screenWidth - 100) / (totalFlowers + 1)) : 180;

            allFlowers.forEach((flowerData, index) => {
                console.log(`üå∏ Creating flower ${index + 1}: ${flowerData.title} (${flowerData.mood})`);
                createFlowerElement(flowerData, index, spacing);
            });
        }

        function createFlowerElement(flowerData, index, spacing) {
            console.log(`üå∏ Creating flower element:`, flowerData);
            
            // Use flowerType from database or fallback to mood mapping
            const type = flowerData.flowerType || (() => {
                const typeMap = {
                    extremely_sad: "wilted",
                    sad: "tulip",
                    neutral: "rose",
                    slightly_happy: "daisy",
                    very_happy: "sunflower"
                };
                return typeMap[flowerData.mood] || "rose";
            })();

            console.log(`üå∏ Flower type: ${type}`);

            const flower = document.createElement("div");
            flower.classList.add("flower", type);
            flower.style.left = `${(index + 1) * spacing + 40}px`;
            flower.style.cursor = "pointer";
            flower.dataset.flowerId = flowerData._id || flowerData.id;
            
            // Apply color if available
            if (flowerData.color) {
                flower.style.setProperty('--flower-color', flowerData.color);
            }

            const stem = document.createElement("div");
            stem.className = "stem";

            if (type === "sunflower") {
                const head = document.createElement("div");
                head.className = "head";
                const center = document.createElement("div");
                center.className = "center";
                for (let i = 0; i < 12; i++) {
                    const p = document.createElement("div");
                    p.className = "petal";
                    const rot = i * 30;
                    p.style.setProperty('--rot', rot + 'deg');
                    p.style.transform = `translateX(-50%) rotate(${rot}deg)`;
                    p.style.animationDelay = `${0.12 * i + 0.2 * index}s`;
                    head.appendChild(p);
                }
                head.appendChild(center);
                flower.append(head, stem);
                setTimeout(() => head.classList.add('show-petals'), 200 + index * 100);
            } else if (type === "daisy") {
                const head = document.createElement("div");
                head.className = "head";
                const center = document.createElement("div");
                center.className = "center";
                for (let i = 0; i < 16; i++) {
                    const p = document.createElement("div");
                    p.className = "petal";
                    const rot = i * 22.5;
                    p.style.setProperty('--rot', rot + 'deg');
                    p.style.transform = `translateX(-50%) rotate(${rot}deg)`;
                    p.style.animationDelay = `${0.08 * i + 0.2 * index}s`;
                    head.appendChild(p);
                }
                head.appendChild(center);
                flower.append(head, stem);
                setTimeout(() => head.classList.add('show-petals'), 200 + index * 100);
            } else if (type === "rose") {
                const head = document.createElement("div");
                head.className = "head";
                const p1 = document.createElement("div");
                p1.className = "petal p1";
                const p2 = document.createElement("div");
                p2.className = "petal p2";
                const p3 = document.createElement("div");
                p3.className = "petal p3";
                const p4 = document.createElement("div");
                p4.className = "petal p4";
                const c = document.createElement("div");
                c.className = "center";
                head.append(p1, p2, p3, p4, c);
                flower.append(head, stem);
            } else if (type === "tulip") {
                const bud = document.createElement("div");
                bud.className = "bud";
                flower.append(bud, stem);
            } else if (type === "wilted") {
                const head = document.createElement("div");
                head.className = "head";
                flower.append(head, stem);
            }

            // Create tooltip with full conversation history
            const tooltip = document.createElement('div');
            tooltip.className = 'flower-tooltip';
            tooltip.style.display = 'none';

            const tooltipTitle = document.createElement('div');
            tooltipTitle.className = 'tooltip-title';
            tooltipTitle.textContent = flowerData.title || 'My Memory';

            const tooltipDate = document.createElement('div');
            tooltipDate.className = 'tooltip-date';
            const date = new Date(flowerData.createdAt || flowerData.date);
            tooltipDate.textContent = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const tooltipSummary = document.createElement('div');
            tooltipSummary.className = 'tooltip-summary';
            tooltipSummary.textContent = flowerData.summary;

            const tooltipContent = document.createElement('div');
            tooltipContent.className = 'tooltip-content';

            // Show full conversation if available
            if (flowerData.content) {
                const contentLines = flowerData.content.split('\n');
                contentLines.forEach(line => {
                    const msgDiv = document.createElement('div');
                    if (line.startsWith('user:')) {
                        msgDiv.className = 'tooltip-msg-user';
                        msgDiv.textContent = line.replace('user:', '').trim();
                    } else if (line.startsWith('assistant:')) {
                        msgDiv.className = 'tooltip-msg-assistant';
                        msgDiv.textContent = line.replace('assistant:', '').trim();
                    }
                    tooltipContent.appendChild(msgDiv);
                });
            }

            tooltip.appendChild(tooltipTitle);
            tooltip.appendChild(tooltipDate);
            tooltip.appendChild(tooltipSummary);
            if (tooltipContent.children.length > 0) {
                const separator = document.createElement('div');
                separator.className = 'tooltip-separator';
                tooltip.appendChild(separator);
                tooltip.appendChild(tooltipContent);
            }

            flower.appendChild(tooltip);

            // Show/hide tooltip on hover
            flower.addEventListener('mouseenter', function() {
                tooltip.style.display = 'block';
            });

            flower.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
            });

            soil.appendChild(flower);
            console.log(`üå∏ Flower added to soil at position: ${flower.style.left}`);
        }

        // ===== Mood UI
        const moodButtons = document.querySelectorAll(".mood-buttons button");

        function clearMoodStyles() {
            moodButtons.forEach(btn => {
                btn.setAttribute("aria-pressed", "false");
                btn.classList.remove("active");
            });
        }

        function markActive(button) {
            clearMoodStyles();
            button.setAttribute("aria-pressed", "true");
            button.classList.add("active");
        }

        const saved = localStorage.getItem(MOOD_KEY);
        if (saved) {
            const btn = Array.from(moodButtons).find(b => b.dataset.mood === saved);
            if (btn) markActive(btn);
        }

        moodButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const mood = button.dataset.mood;
                localStorage.setItem(MOOD_KEY, mood);
                markActive(button);
            });
        });

        // ===== Chat functionality
        const chatWindow = document.getElementById("chatWindow");
        const chatInput = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");
        const finishBtn = document.getElementById("finishBtn");
        const seedInput = document.getElementById("confessionSeed");
        let history = [];

        function addMsg(role, text) {
            const bubble = document.createElement("div");
            bubble.className = `bubble ${role === "user" ? "user" : "assistant"}`;
            bubble.textContent = text;
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function setSending(state) {
            sendBtn.disabled = state;
            sendBtn.style.opacity = state ? "0.7" : "1";
            sendBtn.textContent = state ? "Thinking..." : "Send";
        }

        function setFinishState(state) {
            finishBtn.disabled = state;
            finishBtn.style.opacity = state ? "0.7" : "1";
            finishBtn.textContent = state ? "Saving..." : "Finish";
        }

        async function sendToCoach(userText) {
            setSending(true);
            addMsg("user", userText);

            const live = document.createElement("div");
            live.className = "bubble assistant";
            chatWindow.appendChild(live);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                const res = await fetch(`${BACKEND}/ai/coach`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        mood: currentMood(),
                        message: userText,
                        history
                    }),
                });

                const data = await res.json();
                if (!res.ok) {
                    live.textContent = data.error || "Sorry, I couldn't respond.";
                    return;
                }

                const text = data?.text || "I'm here.";
                live.textContent = text;
                history.push({
                    role: "user",
                    content: userText
                });
                history.push({
                    role: "assistant",
                    content: text
                });

            } catch (e) {
                console.error(e);
                live.textContent = "Network error. Is the server running?";
            } finally {
                setSending(false);
            }
        }

        sendBtn.addEventListener("click", () => {
            const txt = chatInput.value.trim();
            if (!txt) return;
            chatInput.value = "";
            sendToCoach(txt);
        });

        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // FINISH -> Save flower to MongoDB
        finishBtn.addEventListener("click", async() => {
            try {
                if (!history.some(h => h.role === "user")) {
                    addMsg("assistant", "Tell me a bit first, then hit Finish!");
                    return;
                }
                setFinishState(true);

                const seed = (seedInput?.value || "").trim();

                // Get summary from AI
                const res = await fetch(`${BACKEND}/ai/summarize`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        mood: currentMood(),
                        seed,
                        history
                    }),
                });
                const data = await res.json();

                if (!res.ok) {
                    addMsg("assistant", data.error || "Sorry, I couldn't save.");
                    return;
                }

                // Save flower to database
                const saveRes = await fetch(`${BACKEND}/api/flowers/save`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        mood: currentMood(),
                        title: seed || "My Memory",
                        content: history.map(h => `${h.role}: ${h.content}`).join('\n'),
                        summary: data.summary
                    }),
                });

                const savedFlower = await saveRes.json();

                if (saveRes.ok) {
                    addMsg("assistant", `‚úÖ Your flower has been planted!\n\n${data.summary}`);

                    // Add new flower immediately without reloading
                    allFlowers.unshift(savedFlower.flower);
                    displayAllFlowers();

                    // Clear inputs and reset chat
                    seedInput.value = "";
                    chatInput.value = "";
                    chatWindow.innerHTML = '';
                    history = [];
                    addMsg("assistant", "Hey, I'm your Garden Guide. What's on your mind today?");
                }

            } catch (e) {
                console.error(e);
                addMsg("assistant", "Network error while saving.");
            } finally {
                setFinishState(false);
            }
        });

        // Initial load
        if (!history.length) addMsg("assistant", "Hey, I'm your Garden Guide. What's on your mind today?");
        
        // Test flower creation
        console.log("üå∏ Testing flower creation...");
        const testFlower = document.createElement("div");
        testFlower.classList.add("flower", "rose");
        testFlower.style.left = "100px";
        testFlower.style.bottom = "80px";
        testFlower.style.position = "absolute";
        testFlower.style.width = "130px";
        testFlower.style.height = "210px";
        testFlower.style.backgroundColor = "red";
        testFlower.style.zIndex = "10";
        testFlower.textContent = "TEST";
        soil.appendChild(testFlower);
        console.log("üå∏ Test flower added");
        
        loadFlowersFromDB();

        // Reload flowers on window resize
        window.addEventListener('resize', () => {
            displayAllFlowers();
        });
    </script>
</body>

</html>